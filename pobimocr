#!/bin/bash

# POBIMORC CLI - OCR System Management Tool
# Enhanced with hardware detection and selection

VERSION="2.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$SCRIPT_DIR/ocr-backend"
FRONTEND_DIR="$SCRIPT_DIR/ocr-browser"
LOGS_DIR="$SCRIPT_DIR/logs"
BACKEND_PID_FILE="$SCRIPT_DIR/.backend.pid"
FRONTEND_PID_FILE="$SCRIPT_DIR/.frontend.pid"
HARDWARE_CONFIG_FILE="$SCRIPT_DIR/.hardware_config"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Emojis
EMOJI_SUCCESS="âœ…"
EMOJI_ERROR="âŒ"
EMOJI_WARNING="âš ï¸ "
EMOJI_INFO="â„¹ï¸ "
EMOJI_ROCKET="ğŸš€"
EMOJI_GPU="ğŸ®"
EMOJI_CPU="ğŸ’»"
EMOJI_APPLE="ğŸ"

# Print functions
print_banner() {
    clear
    echo -e "${CYAN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                       â•‘"
    echo "â•‘            ${EMOJI_ROCKET}  POBIMORC OCR System  ${EMOJI_ROCKET}           â•‘"
    echo "â•‘          Thai OCR with CRAFT + EasyOCR                â•‘"
    echo "â•‘                  Version $VERSION                       â•‘"
    echo "â•‘                                                       â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_info() {
    echo -e "${BLUE}${EMOJI_INFO}${NC} $1"
}

print_success() {
    echo -e "${GREEN}${EMOJI_SUCCESS}${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}${EMOJI_WARNING}${NC} $1"
}

print_error() {
    echo -e "${RED}${EMOJI_ERROR}${NC} $1"
}

print_step() {
    echo -e "${MAGENTA}âœ${NC} ${BOLD}$1${NC}"
}

print_hardware() {
    echo -e "${CYAN}${EMOJI_GPU}${NC} $1"
}

# Hardware detection functions
detect_hardware() {
    local hw_type="cpu"
    local hw_name="CPU"
    local hw_emoji="${EMOJI_CPU}"

    # Check for NVIDIA GPU
    if command -v nvidia-smi &> /dev/null || [ -f /usr/lib/wsl/lib/nvidia-smi ]; then
        local gpu_name=""
        if command -v nvidia-smi &> /dev/null; then
            gpu_name=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -n1)
        fi
        if [ -n "$gpu_name" ]; then
            hw_type="cuda"
            hw_name="NVIDIA $gpu_name"
            hw_emoji="${EMOJI_GPU}"
        fi
    # Check for Apple Silicon
    elif [[ "$(uname -s)" == "Darwin" ]]; then
        local mac_chip=$(sysctl -n machdep.cpu.brand_string 2>/dev/null)
        if echo "$mac_chip" | grep -qi "Apple"; then
            hw_type="mps"
            hw_name="$mac_chip"
            hw_emoji="${EMOJI_APPLE}"
        fi
    fi

    echo "$hw_type|$hw_name|$hw_emoji"
}

get_hardware_info() {
    if [ -f "$HARDWARE_CONFIG_FILE" ]; then
        cat "$HARDWARE_CONFIG_FILE"
    else
        detect_hardware
    fi
}

save_hardware_config() {
    local hw_type="$1"
    local hw_name="$2"
    local hw_emoji="$3"
    echo "$hw_type|$hw_name|$hw_emoji" > "$HARDWARE_CONFIG_FILE"
}

# Interactive hardware selection
select_hardware() {
    print_banner
    echo -e "${CYAN}${BOLD}Hardware Selection${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    # Auto-detect current hardware
    IFS='|' read -r detected_type detected_name detected_emoji <<< "$(detect_hardware)"

    echo -e "${BOLD}Detected Hardware:${NC}"
    echo -e "  ${detected_emoji} ${detected_name}"
    echo ""

    echo -e "${BOLD}Select your hardware configuration:${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}. ${EMOJI_GPU} NVIDIA GPU (CUDA)"
    echo -e "     ${CYAN}â†’${NC} Best performance for RTX 3060/4090, etc."
    echo -e "     ${CYAN}â†’${NC} Uses GPU acceleration + 4-bit quantization"
    echo ""
    echo -e "  ${GREEN}2${NC}. ${EMOJI_APPLE} Apple Silicon (M1/M2/M3/M4)"
    echo -e "     ${CYAN}â†’${NC} Optimized for Mac with MPS (Metal Performance Shaders)"
    echo -e "     ${CYAN}â†’${NC} Uses GPU acceleration + fp16 precision"
    echo ""
    echo -e "  ${GREEN}3${NC}. ${EMOJI_CPU} CPU Only"
    echo -e "     ${CYAN}â†’${NC} Compatible with all systems"
    echo -e "     ${CYAN}â†’${NC} Slower but works everywhere"
    echo ""
    echo -e "  ${YELLOW}0${NC}. Auto-detect (Recommended)"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    while true; do
        echo -ne "${CYAN}${BOLD}Choose [0-3]:${NC} "
        read -r choice

        case "$choice" in
            0)
                hw_type="$detected_type"
                hw_name="$detected_name"
                hw_emoji="$detected_emoji"
                print_info "Auto-detected: ${hw_emoji} ${hw_name}"
                break
                ;;
            1)
                hw_type="cuda"
                hw_name="NVIDIA GPU (CUDA)"
                hw_emoji="${EMOJI_GPU}"
                print_success "Selected: ${hw_emoji} ${hw_name}"
                break
                ;;
            2)
                hw_type="mps"
                hw_name="Apple Silicon (MPS)"
                hw_emoji="${EMOJI_APPLE}"
                print_success "Selected: ${hw_emoji} ${hw_name}"
                break
                ;;
            3)
                hw_type="cpu"
                hw_name="CPU Only"
                hw_emoji="${EMOJI_CPU}"
                print_success "Selected: ${hw_emoji} ${hw_name}"
                break
                ;;
            *)
                print_error "Invalid choice. Please enter 0-3."
                continue
                ;;
        esac
    done

    # Save configuration
    save_hardware_config "$hw_type" "$hw_name" "$hw_emoji"

    echo ""
    echo -e "${GREEN}${BOLD}Configuration saved!${NC}"
    echo ""
    sleep 1
}

# Show current hardware config
show_hardware_config() {
    if [ -f "$HARDWARE_CONFIG_FILE" ]; then
        IFS='|' read -r hw_type hw_name hw_emoji <<< "$(get_hardware_info)"
        echo -e "${CYAN}Current Hardware:${NC} ${hw_emoji} ${hw_name} (${hw_type})"
        return 0
    else
        echo -e "${YELLOW}No hardware configuration found${NC}"
        return 1
    fi
}

# Setup command with hardware selection
cmd_setup() {
    print_banner
    print_step "Starting POBIMORC Setup..."
    echo ""

    # Step 1: Hardware Selection
    if [ ! -f "$HARDWARE_CONFIG_FILE" ] || [ "$1" == "--reconfigure" ]; then
        select_hardware
    else
        show_hardware_config
        echo ""
        echo -ne "${YELLOW}Use existing configuration? [Y/n]:${NC} "
        read -r use_existing
        if [[ "$use_existing" =~ ^[Nn] ]]; then
            select_hardware
        fi
    fi

    IFS='|' read -r hw_type hw_name hw_emoji <<< "$(get_hardware_info)"

    print_banner
    print_step "Installing for: ${hw_emoji} ${hw_name}"
    echo ""

    # Step 2: Check Python 3.12
    print_step "Checking Python 3.12..."

    PYTHON_CMD=""
    if command -v python3.12 &> /dev/null; then
        PYTHON_CMD="python3.12"
    elif command -v python3 &> /dev/null; then
        # Check if python3 is actually 3.12
        PY_VERSION=$(python3 --version 2>&1 | grep -oE '3\.[0-9]+')
        if [ "$PY_VERSION" == "3.12" ]; then
            PYTHON_CMD="python3"
        fi
    fi

    if [ -z "$PYTHON_CMD" ]; then
        print_error "Python 3.12 not found!"
        if [[ "$(uname -s)" == "Darwin" ]]; then
            print_info "Install with: brew install python@3.12"
        else
            print_info "Install with: sudo apt-get install python3.12 python3.12-venv"
        fi
        exit 1
    fi

    PYTHON_VERSION=$($PYTHON_CMD --version 2>&1)
    print_success "Found $PYTHON_VERSION"

    # Step 3: Check Node.js
    print_step "Checking Node.js..."
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node --version)
        print_success "Found Node.js $NODE_VERSION"
    else
        print_error "Node.js not found!"
        print_info "Visit: https://nodejs.org/"
        exit 1
    fi

    echo ""

    # Step 4: Setup Python Backend
    print_step "Setting up Python backend..."
    cd "$BACKEND_DIR"

    if [ -d "venv" ]; then
        print_warning "Removing old virtual environment..."
        rm -rf venv
    fi

    print_info "Creating Python 3.12 virtual environment..."
    $PYTHON_CMD -m venv venv

    if [ $? -ne 0 ]; then
        print_error "Failed to create virtual environment!"
        print_info "Make sure python3.12-venv is installed:"
        if [[ "$(uname -s)" == "Darwin" ]]; then
            print_info "  brew install python@3.12"
        else
            print_info "  sudo apt-get install python3.12-venv"
        fi
        exit 1
    fi

    if [ ! -d "venv" ] || [ ! -f "venv/bin/activate" ]; then
        print_error "Virtual environment was not created properly!"
        print_info "venv directory exists: $([ -d 'venv' ] && echo 'yes' || echo 'no')"
        print_info "activate script exists: $([ -f 'venv/bin/activate' ] && echo 'yes' || echo 'no')"
        exit 1
    fi

    print_info "Activating virtual environment..."
    source venv/bin/activate

    if [ $? -ne 0 ]; then
        print_error "Failed to activate virtual environment!"
        exit 1
    fi

    print_info "Upgrading pip..."
    if ! command -v pip &> /dev/null; then
        print_error "pip command not found after activating venv!"
        print_info "Virtual environment may not be activated properly"
        deactivate 2>/dev/null || true
        exit 1
    fi

    pip install --upgrade pip setuptools wheel --quiet

    if [ $? -ne 0 ]; then
        print_error "Failed to upgrade pip!"
        deactivate
        exit 1
    fi

    print_success "Pip upgraded"

    # Step 5: Install requirements based on hardware
    print_step "Installing Python dependencies for ${hw_emoji} ${hw_type}..."

    case "$hw_type" in
        cuda)
            print_info "Installing CUDA-optimized packages..."
            pip install -r requirements-cuda.txt
            ;;
        mps)
            print_info "Installing Apple Silicon (MPS) packages..."
            pip install -r requirements-mps.txt
            ;;
        cpu)
            print_info "Installing CPU-only packages..."
            pip install -r requirements-cpu.txt
            ;;
    esac

    if [ $? -ne 0 ]; then
        print_error "Failed to install dependencies!"
        deactivate 2>/dev/null || true
        exit 1
    fi

    print_success "Dependencies installed successfully!"

    # Step 6: Fix CRAFT compatibility
    print_step "Applying CRAFT compatibility fix..."
    CRAFT_VGG_FILE="venv/lib/python3.12/site-packages/craft_text_detector/models/basenet/vgg16_bn.py"

    if [ -f "$CRAFT_VGG_FILE" ]; then
        python3.12 << 'EOF'
import sys

vgg_file = "venv/lib/python3.12/site-packages/craft_text_detector/models/basenet/vgg16_bn.py"

try:
    with open(vgg_file, 'r') as f:
        lines = f.readlines()

    new_lines = []
    i = 0

    while i < len(lines):
        line = lines[i]

        if 'from torchvision.models.vgg import model_urls' in line:
            i += 1
            continue
        if 'model_urls["vgg16_bn"]' in line:
            i += 1
            continue

        if 'vgg_pretrained_features = models.vgg16_bn(pretrained=pretrained).features' in line:
            indent = len(line) - len(line.lstrip())
            new_lines.append(' ' * indent + 'if pretrained:\n')
            new_lines.append(' ' * (indent + 4) + 'from torchvision.models import VGG16_BN_Weights\n')
            new_lines.append(' ' * (indent + 4) + 'vgg_pretrained_features = models.vgg16_bn(weights=VGG16_BN_Weights.IMAGENET1K_V1).features\n')
            new_lines.append(' ' * indent + 'else:\n')
            new_lines.append(' ' * (indent + 4) + 'vgg_pretrained_features = models.vgg16_bn(weights=None).features\n')
            i += 1
            continue

        new_lines.append(line)
        i += 1

    with open(vgg_file, 'w') as f:
        f.writelines(new_lines)

    sys.exit(0)

except Exception as e:
    print(f"Error: {e}")
    sys.exit(1)
EOF

        if [ $? -eq 0 ]; then
            print_success "CRAFT compatibility fix applied"
        else
            print_warning "Could not apply compatibility fix (may not be needed)"
        fi
    fi

    deactivate 2>/dev/null || true
    print_success "Backend setup complete!"

    cd "$SCRIPT_DIR"
    echo ""

    # Step 7: Setup Frontend
    print_step "Setting up Next.js frontend..."
    cd "$FRONTEND_DIR"

    if [ -d "node_modules" ]; then
        print_warning "Removing old node_modules..."
        rm -rf node_modules
    fi

    print_info "Installing Node.js dependencies..."
    npm install --silent

    if [ $? -ne 0 ]; then
        print_error "Failed to install Node.js dependencies!"
        cd "$SCRIPT_DIR"
        exit 1
    fi

    if [ ! -f ".env.local" ]; then
        print_info "Creating .env.local..."
        echo "PYTHON_API_URL=http://localhost:8005" > .env.local
    fi

    print_success "Frontend setup complete!"

    cd "$SCRIPT_DIR"
    echo ""

    # Final summary
    print_banner
    echo -e "${GREEN}${BOLD}${EMOJI_ROCKET} Setup Completed Successfully! ${EMOJI_ROCKET}${NC}"
    echo ""
    echo -e "${CYAN}Configuration:${NC}"
    echo -e "  Hardware: ${hw_emoji} ${hw_name}"
    echo -e "  Python:   $(which $PYTHON_CMD)"
    echo -e "  Node.js:  $(which node)"
    echo ""
    echo -e "${CYAN}Next steps:${NC}"
    echo -e "  ${GREEN}./pobimocr start${NC}   - Start services"
    echo -e "  ${GREEN}./pobimocr status${NC}  - Check status"
    echo -e "  ${GREEN}./pobimocr help${NC}    - Show all commands"
    echo ""
}

# Make script executable
if [ ! -x "$0" ]; then
    chmod +x "$0" 2>/dev/null || true
fi

# Simple commands for now (will add full implementation)
case "${1:-help}" in
    setup|install)
        cmd_setup "$2"
        ;;
    *)
        # Use the old script for other commands
        exec "$SCRIPT_DIR/pobimocr.sh" "$@"
        ;;
esac
